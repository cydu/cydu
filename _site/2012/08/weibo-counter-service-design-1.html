<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title> Cydu &raquo; [微架构设计]微博计数器的设计(上)</title>
        <link href="/atom.xml" rel="alternate" title="Cydu" type="application/atom+xml">
        <link href="/static/common.css" rel="stylesheet">
        <link href="/static/font-awesome.css" rel="stylesheet">
        <script src="/static/highlight.pack.js"></script>
        <link href="/static/highlight.css" rel="stylesheet">
        <script>hljs.initHighlightingOnLoad();</script>
    </head>
    <body>
        <div id="container">
            <div id="header">
                <h1><a href="/">Cydu's blog</a></h1>
                <h2>Keep it Simple & Stupid!</h2>
            </div>
            <div id="main">
                <div id="side">
                    <form class="form-search" action="http://www.google.com/search" method="get">
  <input type="text" class="span12 search-query" name="as_q" placeholder="Search" />
  <input type="hidden" name="sitesearch" value="http://blog.cydu.net/" />
</form>

                    <br>
                    <h1>Email</h1>
                    <ul>
                        <li><img width=150 src="/image/email.png"></li>
                    </ul>
                    <h1>SUBSCRIBE</h1>
                    <ul>
                        <li><a href="/rss.xml"><span class="icon-rss"></span>Rss Feed</a></li>
                        <li><a href="/atom.xml"><span class="icon-rss"></span>Atom Feed</a></li>
                    </ul>
                    <h1>CONTACT ME</h1>
                    <ul>
                        <li><a href="/about.html"><span class="icon-user"></span>About Cydu</a></li>
                        <li><a href="http://weibo.com/cydu"><span class="icon-globe"></span>Weibo</a></li>
                        <li><a href="http://twitter.com/cydu"><span class="icon-twitter"></span>Twitter</a></li>
                        <li><a href="https://github.com/cydu"><span class="icon-github"></span>Github</a></li>
                        <li><a href="http://cn.linkedin.com/in/chuanying"><i class="icon-linkedin"></i> LinkedIn</a></li>
                    </ul>
                   <h1>categories</h1>
                    <ul>
                        
                        <li><a href="/categories.html#category_微扯蛋"><span class="icon-folder-close"></span>微扯蛋 (1)</a></li>
                        
                        <li><a href="/categories.html#category_weibo design"><span class="icon-folder-close"></span>weibo design (2)</a></li>
                        
                        <li><a href="/categories.html#category_cydu"><span class="icon-folder-close"></span>cydu (1)</a></li>
                        
                    </ul>
                    <h1>tags</h1>
                    <ul>
                        
                        <li><a href="/tags.html#tag_微博平台架构"><span class="icon-tag"></span>微博平台架构 (2)</a></li>
                        
                        <li><a href="/tags.html#tag_再见"><span class="icon-tag"></span>再见 (1)</a></li>
                        
                        <li><a href="/tags.html#tag_离职"><span class="icon-tag"></span>离职 (1)</a></li>
                        
                        <li><a href="/tags.html#tag_cy分类法"><span class="icon-tag"></span>cy分类法 (1)</a></li>
                        
                        <li><a href="/tags.html#tag_感谢"><span class="icon-tag"></span>感谢 (1)</a></li>
                        
                        <li><a href="/tags.html#tag_微架构设计"><span class="icon-tag"></span>微架构设计 (2)</a></li>
                        
                        <li><a href="/tags.html#tag_cydu"><span class="icon-tag"></span>cydu (1)</a></li>
                        
                        <li><a href="/tags.html#tag_计数器"><span class="icon-tag"></span>计数器 (2)</a></li>
                        
                        <li><a href="/tags.html#tag_价值观"><span class="icon-tag"></span>价值观 (1)</a></li>
                        
                        <li><a href="/tags.html#tag_weibo"><span class="icon-tag"></span>weibo (1)</a></li>
                        
                        <li><a href="/tags.html#tag_百度"><span class="icon-tag"></span>百度 (1)</a></li>
                        
                    </ul>
                    <h1>archives</h1>
                    <ul>
                        
                        
                        

                        
                        
                        
                        

                        
                        
                        

                        

                        

                        
                        

                        
                        
                        

                        

                        

                        
                        

                        
                        <li><a href="/archives.html#archive_2012_09"><span class="icon-hdd"></span>Sep 2012 (2)</a></li>
                        
                        
                        

                        

                        

                        
                        

                        
                        <li><a href="/archives.html#archive_2012_08"><span class="icon-hdd"></span>Aug 2012 (1)</a></li>
                        
                        
                        

                        
                        <li><a href="/archives.html#archive_2012_07"><span class="icon-hdd"></span>Jul 2012 (1)</a></li>
                        

                        
                    </ul>
                </div>
                <div class="post">
    <h1>[微架构设计]微博计数器的设计(上)</h1>
    <span class="hang">30 Aug 2012</span>
    <p class="meta">
    Category: <a href="/categories.html#category_weibo design">weibo design</a>. Tags: 
    
    <a href="/tags.html#tag_计数器">计数器</a>,
    
    <a href="/tags.html#tag_微架构设计">微架构设计</a>,
    
    <a href="/tags.html#tag_微博平台架构">微博平台架构</a>.
    
    </p>

    <p>正式入职新浪微博一个月了，一切安好，各位勿念。 也多谢各位猎头抬爱，但是请不要再骚扰了，近期完全没有找工作的兴趣。</p>

<p>入职这一个月，虽然大多时间是在熟悉架构的一些细节，但是也深深地感受到了weibo平台巨大的流量和社会影响力(对于服务稳定性提出了近乎苛刻的要求)带给架构师们的巨大挑战和压力，当然这也是几乎每一位架构师都梦寐以求的机会！</p>

<!-- more start -->


<hr />

<p>闲话少说，上点干货.</p>

<p><strong>背景:</strong></p>

<pre><code>每一条微博的转发和评论背后都是一串串说不完的故事，但是今天主要讲的是 **计数服务**，计数服务详尽地记录着每条微博 被评论的次数 和 被转发的次数，当然也还有更多的喜怒哀乐都记录于此。 
</code></pre>

<p><strong>数据量:</strong></p>

<pre><code>微博总数量:  

    千亿级 而且每秒都在飞速增长中。每条微博都有一个64位的唯一id。

访问量:  

    每秒百万级 还在稳步增长中。  根据微博的id来访问。
</code></pre>

<p><strong>主要接口:</strong></p>

<pre><code>增加评论数 (默认为0)

增加转发数 (默认为0)

获取评论数

获取转发数

获取评论数 + 获取转发数  (这个接口访问量最大)

评论数和转发数，你都可以认为是 32位的整形数值。不会是负数，默认是0。
</code></pre>

<p><strong>要求:</strong></p>

<pre><code>由于用户对于数字非常的敏感(想想你好不容易拉到一位粉丝，但是粉丝数没涨的痛苦吧。)，所以我们要求数据非常准确，延迟极低(1s以内)，服务稳定性极高(千万别因为某大妈扫个地拨了插座就把数字弄没了...) 
</code></pre>

<hr />

<p>做为架构师，当然也需要全方位地考虑架构成本问题，然后去做各种的折衷。 这里主要考虑的成本是: 机器成本，开发成本，维护成本。</p>

<hr />

<p>有兴趣的架构师和准架构师们可以一起思考，怎样才能用最少的机器，最短时间内开发出最易维护的计数器系统。。。当然，得满足我们数据量，性能和高可用的要求。</p>

<p>对这一块非常的感兴趣，而且有靠谱的想法和建议，烦请私信简历给 <a href="http://www.weibo.com/n/cydu">@cydu</a> 或者 <a href="http://weibo.com/n/%E5%BE%AE%E5%8D%9A%E5%B9%B3%E5%8F%B0%E6%9E%B6%E6%9E%84">@微博平台架构</a>，我们这里还有大量类似的问题期待着你来解决！   当然，也可以直接评论一起讨论。</p>

<p><strong>PS:</strong></p>

<pre><code>后面我会给出我们的理解和解决的思路，期待大家一起来优化。
</code></pre>

<!-- more end -->



    <div id="post_neighbours">
        
        <div class="left"><a href="/2012/07/say-goodbye-to-baidu.html">&laquo; 那些年我们一起写代码--杜传赢和各位说再见</a></div>
        
        
        <div class="right"><a href="/2012/09/weibo-counter-service-design-2.html">[微架构设计]微博计数器的设计(下) &raquo;</a></div>
        
    </div>

</div>


            </div>
            <div id="footer">
                <p>Powered by <a href="https://github.com/mojombo/jekyll">Jekyll</a> and <a href="http://fortawesome.github.com/Font-Awesome">Font Awesome</a>.</p>
                <p>Designed and provided by <a href="http://weibo.com/cydu">@cydu</a>.</p>
            </div>
        </div>
        <script type="text/javascript">
var _bdhmProtocol = (("https:" == document.location.protocol) ? " https://" : " http://");
document.write(unescape("%3Cscript src='" + _bdhmProtocol + "hm.baidu.com/h.js%3F5841bd9b5a719b3703135c5fe2a74be9' type='text/javascript'%3E%3C/script%3E"));
</script>

<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-35006729-1']);
  _gaq.push(['_trackPageview']);
  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>



    </body>
</html>
